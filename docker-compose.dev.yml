# Development-specific Docker Compose configuration
# Use this for development with live code reloading
services:
  decision_engine:
    build: 
      context: .
      dockerfile: Dockerfile
    ports:
      - "4000:4000"
    environment:
      - MIX_ENV=dev
      - PHX_HOST=0.0.0.0
      - PHX_PORT=4000
      - PHX_LIVE_RELOAD_URL=ws://localhost:4000/phoenix/live_reload/socket/websocket
      # LM Studio configuration for testing
      - LLM_PROVIDER=${LLM_PROVIDER:-lmstudio}
      - LLM_ENDPOINT=${LLM_ENDPOINT:-http://host.docker.internal:1234}
      - LLM_MODEL=${LLM_MODEL:-local-model}
      - LLM_TIMEOUT=${LLM_TIMEOUT:-300000}
      - DOCKER_TEST=${DOCKER_TEST:-false}
    volumes:
      # Mount source code for live reloading
      - .:/app
      - /app/deps
      - /app/_build
      - /app/assets/node_modules
      - uploads_data:/app/priv/static/uploads
    stdin_open: true
    tty: true
    command: >
      sh -c "
        cd /app &&
        mix deps.get &&
        cd assets && npm install && cd .. &&
        mix assets.setup &&
        mix phx.server
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  uploads_data: